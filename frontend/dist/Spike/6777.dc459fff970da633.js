"use strict";(self.webpackChunkSpike=self.webpackChunkSpike||[]).push([[6777],{6777:(rt,b,s)=>{s.r(b),s.d(b,{SOLICITUDES_DEL_DIA_ROUTES:()=>ct});var v=s(467),f=s(177),S=s(5596),d=s(9159),h=s(8834),g=s(9213),p=s(3719),_=s(9631),u=s(4006),T=s(3902),E=s(9183),D=s(9417),t=s(3953),x=s(1787);function j(i,a){1&i&&(t.j41(0,"div",11),t.nrm(1,"mat-spinner",12),t.k0s())}function k(i,a){1&i&&(t.j41(0,"div",11),t.EFF(1," No se encontraron t\xe9cnicos "),t.k0s())}function N(i,a){if(1&i&&(t.j41(0,"mat-list-option",13)(1,"div",14)(2,"span"),t.EFF(3),t.k0s()()()),2&i){const e=a.$implicit,n=t.XpG();t.Y8G("value",e.id)("selected",e.id===n.data.currentTecnicoId),t.R7$(3),t.Lme("",e.name," ",e.lastName,"")}}let R=(()=>{class i{constructor(e,n,o){this.dialogRef=e,this.data=n,this.solicitarVisitaService=o,this.tecnicos=[],this.filteredTecnicos=[],this.isLoading=!1,this.searchText=""}ngOnInit(){this.loadTecnicos()}loadTecnicos(){this.isLoading=!0,this.solicitarVisitaService.getTecnicos().subscribe({next:e=>{this.tecnicos=e.data||e,this.filteredTecnicos=[...this.tecnicos],this.isLoading=!1},error:e=>{console.error("Error loading tecnicos:",e),this.isLoading=!1}})}filterTecnicos(){if(!this.searchText)return void(this.filteredTecnicos=[...this.tecnicos]);const e=this.searchText.toLowerCase();this.filteredTecnicos=this.tecnicos.filter(n=>n.name.toLowerCase().includes(e)||n.lastName.toLowerCase().includes(e))}onNoClick(){this.dialogRef.close()}onConfirm(e){e&&this.dialogRef.close({tecnicoId:e,tipo:this.data.tipo})}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(u.CP),t.rXU(u.Vh),t.rXU(x.I))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["app-tecnico-selection-modal"]],standalone:!0,features:[t.aNF],decls:19,vars:6,consts:[["tecnicoList",""],["mat-dialog-title",""],["appearance","outline",1,"w-100","mb-3"],["matInput","","placeholder","Nombre del t\xe9cnico",3,"ngModelChange","keyup","ngModel"],["matSuffix",""],["class","text-center p-3",4,"ngIf"],[3,"multiple"],[3,"value","selected",4,"ngFor","ngForOf"],["align","end"],["mat-button","",3,"click"],["mat-raised-button","","color","primary",3,"click","disabled"],[1,"text-center","p-3"],["diameter","40"],[3,"value","selected"],[1,"d-flex","align-items-center"]],template:function(n,o){if(1&n){const c=t.RV6();t.j41(0,"h2",1),t.EFF(1,"Seleccionar T\xe9cnico"),t.k0s(),t.j41(2,"mat-dialog-content")(3,"mat-form-field",2)(4,"mat-label"),t.EFF(5,"Buscar t\xe9cnico"),t.k0s(),t.j41(6,"input",3),t.mxI("ngModelChange",function(l){return t.eBV(c),t.DH7(o.searchText,l)||(o.searchText=l),t.Njj(l)}),t.bIt("keyup",function(){return t.eBV(c),t.Njj(o.filterTecnicos())}),t.k0s(),t.j41(7,"mat-icon",4),t.EFF(8,"search"),t.k0s()(),t.DNE(9,j,2,0,"div",5)(10,k,2,0,"div",5),t.j41(11,"mat-selection-list",6,0),t.DNE(13,N,4,4,"mat-list-option",7),t.k0s()(),t.j41(14,"mat-dialog-actions",8)(15,"button",9),t.bIt("click",function(){return t.eBV(c),t.Njj(o.onNoClick())}),t.EFF(16,"Cancelar"),t.k0s(),t.j41(17,"button",10),t.bIt("click",function(){t.eBV(c);const l=t.sdS(12);return t.Njj(o.onConfirm(null==l.selectedOptions.selected[0]?null:l.selectedOptions.selected[0].value))}),t.EFF(18," Confirmar "),t.k0s()()}if(2&n){const c=t.sdS(12);t.R7$(6),t.R50("ngModel",o.searchText),t.R7$(3),t.Y8G("ngIf",o.isLoading),t.R7$(),t.Y8G("ngIf",!o.isLoading&&0===o.filteredTecnicos.length),t.R7$(),t.Y8G("multiple",!1),t.R7$(2),t.Y8G("ngForOf",o.filteredTecnicos),t.R7$(4),t.Y8G("disabled",!c.selectedOptions.selected.length)}},dependencies:[f.MD,f.Sq,f.bT,u.hM,u.BI,u.E7,u.Yi,h.Hl,h.$z,T.Fg,T.p6,T.oh,E.D6,E.LG,p.RG,p.rl,p.nJ,p.yw,_.fS,_.fg,D.YN,D.me,D.BC,D.vS,g.m_,g.An],styles:["mat-dialog-content[_ngcontent-%COMP%]{min-height:200px;max-height:400px}.w-100[_ngcontent-%COMP%]{width:100%}.mb-3[_ngcontent-%COMP%]{margin-bottom:1rem}"]})}return i})();var F=s(4823),$=s(8032),m=s.n($),C=s(2288),w=s(7291);function y(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"N\xfamero de Solicitud"),t.k0s())}function I(i,a){if(1&i&&(t.j41(0,"td",26),t.EFF(1),t.k0s()),2&i){const e=a.$implicit;t.R7$(),t.JRh(e.id)}}function V(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"Cliente"),t.k0s())}function L(i,a){if(1&i&&(t.j41(0,"td",26),t.EFF(1),t.k0s()),2&i){const e=a.$implicit;t.R7$(),t.JRh(null==e.client?null:e.client.nombre)}}function M(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"Local"),t.k0s())}function G(i,a){if(1&i&&(t.j41(0,"td",26),t.EFF(1),t.k0s()),2&i){const e=a.$implicit;t.R7$(),t.JRh(null==e.local?null:e.local.nombre_local)}}function B(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"Tipo Servicio"),t.k0s())}function O(i,a){if(1&i&&(t.j41(0,"td",26),t.EFF(1),t.k0s()),2&i){const e=a.$implicit;t.R7$(),t.JRh(null==e.tipoServicio?null:e.tipoServicio.nombre)}}function A(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"Estado"),t.k0s())}function Y(i,a){if(1&i&&(t.j41(0,"td",26),t.EFF(1),t.k0s()),2&i){const e=a.$implicit;t.R7$(),t.JRh(e.status)}}function P(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"Generado por"),t.k0s())}function U(i,a){if(1&i&&(t.j41(0,"td",26),t.EFF(1),t.k0s()),2&i){const e=a.$implicit;t.R7$(),t.Lme("",e.generada_por.name," ",e.generada_por.lastName,"")}}function X(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"T\xe9cnico"),t.k0s())}function z(i,a){if(1&i&&(t.j41(0,"div",30),t.EFF(1),t.k0s()),2&i){const e=t.XpG().$implicit;t.R7$(),t.Lme(" ",null==e.tecnico_asignado?null:e.tecnico_asignado.name," ",null==e.tecnico_asignado?null:e.tecnico_asignado.lastName," ")}}function J(i,a){if(1&i){const e=t.RV6();t.j41(0,"td",26)(1,"div",27),t.DNE(2,z,2,2,"div",28),t.j41(3,"button",29),t.bIt("click",function(){const o=t.eBV(e).$implicit,c=t.XpG();return t.Njj(c.openTecnicoModal(o,"tecnico"))}),t.j41(4,"mat-icon"),t.EFF(5),t.k0s()()()()}if(2&i){const e=a.$implicit;t.R7$(2),t.Y8G("ngIf",e.tecnico_asignado),t.R7$(),t.Y8G("matTooltip",e.tecnico_asignado?"Cambiar t\xe9cnico":"Agregar t\xe9cnico"),t.R7$(2),t.JRh(e.tecnico_asignado?"swap_horiz":"person_add")}}function H(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"T\xe9cnico 2"),t.k0s())}function W(i,a){if(1&i&&(t.j41(0,"div",30),t.EFF(1),t.k0s()),2&i){const e=t.XpG().$implicit;t.R7$(),t.Lme(" ",null==e.tecnico_asignado_2?null:e.tecnico_asignado_2.name," ",null==e.tecnico_asignado_2?null:e.tecnico_asignado_2.lastName," ")}}function Z(i,a){if(1&i){const e=t.RV6();t.j41(0,"td",26)(1,"div",27),t.DNE(2,W,2,2,"div",28),t.j41(3,"button",29),t.bIt("click",function(){const o=t.eBV(e).$implicit,c=t.XpG();return t.Njj(c.openTecnicoModal(o,"tecnico_2"))}),t.j41(4,"mat-icon"),t.EFF(5),t.k0s()()()()}if(2&i){const e=a.$implicit;t.R7$(2),t.Y8G("ngIf",e.tecnico_asignado_2),t.R7$(),t.Y8G("matTooltip",e.tecnico_asignado_2?"Cambiar t\xe9cnico 2":"Agregar t\xe9cnico 2"),t.R7$(2),t.JRh(e.tecnico_asignado_2?"swap_horiz":"person_add")}}function K(i,a){1&i&&(t.j41(0,"th",25),t.EFF(1,"Acciones"),t.k0s())}function Q(i,a){if(1&i){const e=t.RV6();t.j41(0,"button",34),t.bIt("click",function(){t.eBV(e);const o=t.XpG().$implicit,c=t.XpG();return t.Njj(c.cambiarAAtendidaEnProceso(o))}),t.j41(1,"mat-icon"),t.EFF(2,"engineering"),t.k0s()()}}function q(i,a){if(1&i){const e=t.RV6();t.j41(0,"button",35),t.bIt("click",function(){t.eBV(e);const o=t.XpG().$implicit,c=t.XpG();return t.Njj(c.deleteSolicitud(o))}),t.j41(1,"mat-icon"),t.EFF(2,"delete"),t.k0s()()}}function tt(i,a){if(1&i&&(t.j41(0,"td",26)(1,"div",31),t.DNE(2,Q,3,0,"button",32)(3,q,3,0,"button",33),t.k0s()()),2&i){const e=a.$implicit,n=t.XpG();t.R7$(2),t.Y8G("ngIf","en_servicio"===(null==e.status?null:e.status.toLowerCase())),t.R7$(),t.Y8G("ngIf",n.canDeleteSolicitud(e))}}function et(i,a){1&i&&t.nrm(0,"tr",36)}function it(i,a){1&i&&t.nrm(0,"tr",37)}function ot(i,a){1&i&&(t.j41(0,"tr",38)(1,"td",39),t.EFF(2,"No hay solicitudes para el d\xeda de hoy"),t.k0s()())}const ct=[{path:"",component:(()=>{class i{constructor(e,n,o){this.solicitarVisitaService=e,this.dialog=n,this.storage=o,this.displayedColumns=["id","cliente","local","tipoServicio","estado","generado_por","tecnico","tecnico_2","acciones"],this.originalData=[],this.dataSource=new d.I6,this.currentUser=this.storage.getCurrentUser(),console.log("Constructor CurrentUser:",this.currentUser)}ngOnInit(){this.cargarSolicitudesDelDia(),this.setupFilter()}setupFilter(){this.dataSource.filterPredicate=(e,n)=>{const o=n.toLowerCase(),c=e.id.toString().includes(o),r=e.client?.nombre?.toLowerCase().includes(o),l=e.local?.nombre_local?.toLowerCase().includes(o),lt=(e.tecnico_asignado?.name+" "+e.tecnico_asignado?.lastName).toLowerCase().includes(o),st=(e.tecnico_asignado_2?.name+" "+e.tecnico_asignado_2?.lastName).toLowerCase().includes(o);return c||r||l||lt||st}}cargarSolicitudesDelDia(){console.log("[Component] Iniciando carga de solicitudes del d\xeda"),this.solicitarVisitaService.getSolicitudesDelDia().subscribe({next:e=>{console.log("[Component] Datos recibidos:",e),e&&e.success?this.originalData=e.data||[]:Array.isArray(e)?this.originalData=e:(console.warn("[Component] Formato de respuesta inesperado:",e),this.originalData=[]),this.dataSource.data=this.originalData},error:e=>{console.error("[Component] Error al cargar solicitudes:",e),this.originalData=[],this.dataSource.data=[]}})}applyFilter(e){this.dataSource.filter=e.target.value.trim().toLowerCase()}openTecnicoModal(e,n){const o="tecnico"===n?e.tecnico_asignado?.id:e.tecnico_asignado_2?.id;this.dialog.open(R,{width:"500px",data:{solicitudId:e.id,currentTecnicoId:o,tipo:n}}).afterClosed().subscribe(r=>{r?.tecnicoId&&(console.log("Modal result:",r),o?(console.log("Changing existing technician"),this.changeTecnico(e.id,r.tecnicoId,n)):(console.log("Assigning new technician"),this.updateTecnicoAsignado(e.id,r.tecnicoId,n,e)))})}updateTecnicoAsignado(e,n,o,c){n!==("tecnico"===o?c.tecnico_asignado_2?.id:c.tecnico_asignado?.id)?this.solicitarVisitaService.asignarTecnico(e,n,o).subscribe({next:()=>{this.cargarSolicitudesDelDia()},error:l=>{console.error("Error updating technician:",l),m().fire({title:"Error",text:l.error.message||"Error al asignar el t\xe9cnico",icon:"error",confirmButtonText:"Ok"})}}):m().fire({title:"Error",text:"tecnico"===o?"El t\xe9cnico ya est\xe1 asignado como t\xe9cnico 2 en esta solicitud":"El t\xe9cnico ya est\xe1 asignado como t\xe9cnico 1 en esta solicitud",icon:"error",confirmButtonText:"Ok"})}changeTecnico(e,n,o){console.log("Changing technician:",{solicitudId:e,tecnicoId:n,tipo:o}),this.solicitarVisitaService.cambiarTecnico(e,n,o).subscribe({next:c=>{console.log("Technician changed successfully:",c),this.cargarSolicitudesDelDia()},error:c=>{console.error("Error changing technician:",c),m().fire({title:"Error",text:c.error.message||"Error al cambiar el t\xe9cnico",icon:"error",confirmButtonText:"Ok"})}})}canDeleteSolicitud(e){console.log("Current User:",this.currentUser),console.log("Generada Por:",e.generada_por),console.log("Status:",e.status);const o=this.currentUser?.id===e.generada_por?.id,c=["aprobada","en_servicio","atendida_en_proceso","pendiente"].includes(e.status?.toLowerCase()),r=o&&c;return console.log("Can Delete:",r,"(isOwner:",o,", hasValidStatus:",c,")"),r}deleteSolicitud(e){this.canDeleteSolicitud(e)&&m().fire({title:"\xbfEst\xe1s seguro?",text:`\xbfDeseas eliminar la solicitud #${e.id}?`,icon:"warning",showCancelButton:!0,confirmButtonText:"S\xed, eliminar",cancelButtonText:"Cancelar"}).then(n=>{n.isConfirmed&&this.solicitarVisitaService.deleteSolicitud(e.id).subscribe({next:()=>{m().fire("Eliminado","La solicitud ha sido eliminada","success"),this.cargarSolicitudesDelDia()},error:o=>{console.error("Error deleting solicitud:",o),m().fire("Error","No se pudo eliminar la solicitud","error")}})})}canChangeToAtendidaEnProceso(e){return"en_servicio"===e.status?.toLowerCase()}cambiarAAtendidaEnProceso(e){var n=this;return(0,v.A)(function*(){if((yield m().fire({title:"\xbfCambiar estado?",text:`\xbfDeseas cambiar el estado de la solicitud #${e.id} a "Atendida en Proceso"?`,icon:"question",showCancelButton:!0,confirmButtonText:"S\xed, cambiar",cancelButtonText:"Cancelar"})).isConfirmed)try{yield n.solicitarVisitaService.cambiarEstado(e.id,"atendida_en_proceso").toPromise(),yield m().fire("\xa1\xc9xito!","El estado ha sido actualizado","success"),n.cargarSolicitudesDelDia()}catch(c){console.error("Error al cambiar estado:",c),yield m().fire("Error","No se pudo cambiar el estado de la solicitud","error")}})()}exportarExcel(){if(!this.dataSource||!this.dataSource.data||0===this.dataSource.data.length)return void m().fire({title:"No hay datos",text:"No hay solicitudes para exportar",icon:"warning",confirmButtonText:"Aceptar"});const e=this.dataSource.data.map(l=>({"N\xfamero de Solicitud":l.id,Cliente:l.client?.nombre||"No asignado",Local:l.local?.nombre_local||"No asignado","Tipo de Servicio":l.tipoServicio?.nombre||"No asignado",Estado:l.status||"No asignado","Generado por":`${l.generada_por?.name||""} ${l.generada_por?.lastName||""}`,T\u00e9cnico:l.tecnico_asignado?`${l.tecnico_asignado.name} ${l.tecnico_asignado.lastName}`:"No asignado","T\xe9cnico 2":l.tecnico_asignado_2?`${l.tecnico_asignado_2.name} ${l.tecnico_asignado_2.lastName}`:"No asignado"})),n=C.Wp.book_new(),o=C.Wp.json_to_sheet(e);o["!cols"]=[{wch:15},{wch:30},{wch:30},{wch:25},{wch:15},{wch:30},{wch:30},{wch:30}],C.Wp.book_append_sheet(n,o,"Solicitudes del D\xeda");const r=(new Date).toISOString().split("T")[0];C._h(n,`Solicitudes_Del_Dia_${r}.xlsx`),m().fire({title:"\xa1\xc9xito!",text:"El archivo Excel se ha descargado correctamente",icon:"success",timer:2e3,showConfirmButton:!1})}static#t=this.\u0275fac=function(n){return new(n||i)(t.rXU(x.I),t.rXU(u.bZ),t.rXU(w.n))};static#e=this.\u0275cmp=t.VBU({type:i,selectors:[["app-solicitudes-del-dia"]],standalone:!0,features:[t.aNF],decls:45,vars:3,consts:[["input",""],[1,"cardWithShadow"],[1,"p-24"],[1,"row","justify-content-between","m-b-8"],[1,"col-sm-4","col-lg-3"],["appearance","outline",1,"w-100","hide-hint"],["matInput","","placeholder","Buscar",3,"keyup"],[1,"action-buttons","mb-3"],["mat-stroked-button","","color","primary",3,"click"],[1,"table-responsive","m-t-30"],["mat-table","",1,"w-100","mat-elevation-z8",3,"dataSource"],["matColumnDef","id"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","cliente"],["matColumnDef","local"],["matColumnDef","tipoServicio"],["matColumnDef","estado"],["matColumnDef","generado_por"],["matColumnDef","tecnico"],["matColumnDef","tecnico_2"],["matColumnDef","acciones"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["class","mat-row",4,"matNoDataRow"],["mat-header-cell",""],["mat-cell",""],[1,"d-flex","align-items-center"],["class","user-chip",4,"ngIf"],["mat-icon-button","","color","primary",3,"click","matTooltip"],[1,"user-chip"],[1,"d-flex","gap-2"],["mat-icon-button","","color","primary","matTooltip","Cambiar a Atendida en Proceso",3,"click",4,"ngIf"],["mat-icon-button","","color","warn","matTooltip","Eliminar solicitud",3,"click",4,"ngIf"],["mat-icon-button","","color","primary","matTooltip","Cambiar a Atendida en Proceso",3,"click"],["mat-icon-button","","color","warn","matTooltip","Eliminar solicitud",3,"click"],["mat-header-row",""],["mat-row",""],[1,"mat-row"],["colspan","7",1,"mat-cell"]],template:function(n,o){if(1&n){const c=t.RV6();t.j41(0,"mat-card",1)(1,"mat-card-content",2)(2,"div",3),t.nrm(3,"div",4),t.j41(4,"div",4)(5,"mat-form-field",5)(6,"input",6,0),t.bIt("keyup",function(l){return t.eBV(c),t.Njj(o.applyFilter(l))}),t.k0s()()()(),t.j41(8,"div",7)(9,"button",8),t.bIt("click",function(){return t.eBV(c),t.Njj(o.exportarExcel())}),t.j41(10,"mat-icon"),t.EFF(11,"file_download"),t.k0s(),t.EFF(12," Exportar a Excel "),t.k0s()(),t.j41(13,"div",9)(14,"table",10),t.qex(15,11),t.DNE(16,y,2,0,"th",12)(17,I,2,1,"td",13),t.bVm(),t.qex(18,14),t.DNE(19,V,2,0,"th",12)(20,L,2,1,"td",13),t.bVm(),t.qex(21,15),t.DNE(22,M,2,0,"th",12)(23,G,2,1,"td",13),t.bVm(),t.qex(24,16),t.DNE(25,B,2,0,"th",12)(26,O,2,1,"td",13),t.bVm(),t.qex(27,17),t.DNE(28,A,2,0,"th",12)(29,Y,2,1,"td",13),t.bVm(),t.qex(30,18),t.DNE(31,P,2,0,"th",12)(32,U,2,2,"td",13),t.bVm(),t.qex(33,19),t.DNE(34,X,2,0,"th",12)(35,J,6,3,"td",13),t.bVm(),t.qex(36,20),t.DNE(37,H,2,0,"th",12)(38,Z,6,3,"td",13),t.bVm(),t.qex(39,21),t.DNE(40,K,2,0,"th",12)(41,tt,4,2,"td",13),t.bVm(),t.DNE(42,et,1,0,"tr",22)(43,it,1,0,"tr",23)(44,ot,3,0,"tr",24),t.k0s()()()()}2&n&&(t.R7$(14),t.Y8G("dataSource",o.dataSource),t.R7$(28),t.Y8G("matHeaderRowDef",o.displayedColumns),t.R7$(),t.Y8G("matRowDefColumns",o.displayedColumns))},dependencies:[f.MD,f.bT,S.Hu,S.RN,S.m2,d.tP,d.Zl,d.tL,d.ji,d.cC,d.YV,d.iL,d.KS,d.$R,d.YZ,d.NB,d.ky,h.Hl,h.$z,h.iY,g.m_,g.An,p.RG,p.rl,_.fS,_.fg,u.hM,F.uc,F.oV],styles:[".badge[_ngcontent-%COMP%]{padding:6px 12px;border-radius:16px;font-size:12px;font-weight:500;text-transform:capitalize;display:inline-block;min-width:80px;text-align:center}.badge.bg-primary[_ngcontent-%COMP%]{background-color:#1e88e5!important;color:#fff}.badge.bg-warning[_ngcontent-%COMP%]{background-color:#ffc107!important;color:#000}.badge.bg-danger[_ngcontent-%COMP%]{background-color:#ef5350!important;color:#fff}"]})}return i})(),data:{title:`Solicitudes del d\xeda ${(new Date).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"})}`}}]}}]);