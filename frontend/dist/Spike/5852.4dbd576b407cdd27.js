"use strict";(self.webpackChunkSpike=self.webpackChunkSpike||[]).push([[5852],{5852:(G,b,s)=>{s.r(b),s.d(b,{CLIENTE_USUARIOS_ROUTES:()=>V});var n=s(9417),d=s(5596),m=s(3719),g=s(9631),h=s(2798),x=s(8834),E=s(8032),c=s.n(E),F=s(177),U=s(3902),I=s(7575),e=s(3953),k=s(1357),j=s(2902),C=s(8887),O=s(6600);const S=(a,l)=>l.id;function P(a,l){if(1&a&&(e.j41(0,"mat-option",9),e.EFF(1),e.k0s()),2&a){const t=l.$implicit;e.Y8G("value",t),e.R7$(),e.SpI(" ",t," ")}}function w(a,l){if(1&a){const t=e.RV6();e.j41(0,"div",18)(1,"div",22),e.bIt("click",function(){const r=e.eBV(t).$implicit,o=e.XpG();return e.Njj(o.toggleClientSelection(r.id))}),e.nrm(2,"img",23),e.k0s(),e.j41(3,"div",24),e.EFF(4),e.k0s()()}if(2&a){const t=l.$implicit,i=e.XpG();e.R7$(),e.AVh("selected",i.selectedClientIds.includes(t.id)),e.R7$(),e.Y8G("src",t.logo,e.B4B),e.R7$(2),e.JRh(t.nombre)}}let y=(()=>{class a{constructor(t,i,r,o){this.fb=t,this.clientesService=i,this.tecnicosService=r,this.router=o,this.clientes=[],this.perfiles=["user","reporter","admin","superadmin"],this.selectedClientIds=[],this.hasMinLength=!1,this.hasNumber=!1,this.hasSpecialChar=!1,this.hasUpperCase=!1,this.hasLowerCase=!1}ngOnInit(){this.clientesService.getClientesWithGruman().subscribe(t=>{this.clientes=t}),this.clienteUsuarioForm=this.fb.group({perfil:["",n.k0.required],name:["",n.k0.required],email:["",[n.k0.required,n.k0.email]],rut:["",n.k0.required],password:["",n.k0.required],lastName:["",n.k0.required],repetirContrasena:["",n.k0.required],especialidades:[[]]},{validators:this.passwordMatchValidator})}toggleClientSelection(t){const i=this.selectedClientIds.indexOf(t);-1===i?this.selectedClientIds.push(t):this.selectedClientIds.splice(i,1)}trackByClienteId(t,i){return i.id}passwordMatchValidator(t){return t.get("password")?.value===t.get("repetirContrasena")?.value?null:{mismatch:!0}}onSubmit(){if(!this.isFormValid())return void console.error("Formulario inv\xe1lido o sin clientes seleccionados");const t=document.querySelector('button[type="submit"]');t&&(t.disabled=!0);const i=this.clienteUsuarioForm.value;this.tecnicosService.createTecnico({clientId:this.selectedClientIds,perfil:i.perfil,name:i.name,email:i.email,rut:i.rut,password:i.password,repetirContrasena:i.repetirContrasena,lastName:i.lastName,especialidades:[]}).subscribe({next:o=>{c().fire({icon:"success",title:"Usuario creado",text:"El usuario ha sido creado exitosamente."}),this.router.navigate(["/mantenedores/usuarios"])},error:o=>{console.error("Error al crear usuario",o),409===o.statusCode?c().fire({icon:"error",title:"Error",text:"El rut o el email ya est\xe1n en uso."}):c().fire({icon:"error",title:"Error",text:o.error.message}),t&&(t.disabled=!1)}})}isFormValid(){return this.clienteUsuarioForm.valid&&this.selectedClientIds.length>0}onCancel(){this.router.navigate(["/mantenedores/usuarios"])}static#e=this.\u0275fac=function(i){return new(i||a)(e.rXU(n.ok),e.rXU(k.T),e.rXU(j.q),e.rXU(C.Ix))};static#t=this.\u0275cmp=e.VBU({type:a,selectors:[["app-cliente-usuarios"]],standalone:!0,features:[e.aNF],decls:65,vars:2,consts:[[1,"cardWithShadow"],[1,"p-24"],[3,"ngSubmit","formGroup"],[1,"row"],[1,"col-sm-4","d-flex","align-items-center"],[1,"mat-subtitle-2","f-w-600","d-block","m-b-16"],[1,"col-sm-8"],["appearance","outline",1,"w-100"],["formControlName","perfil","placeholder","Seleccionar Perfil"],[3,"value"],["matInput","","formControlName","name","placeholder","Ingrese Nombre"],["matInput","","formControlName","lastName","placeholder","Ingrese Apellido"],["matInput","","formControlName","email","placeholder","Ingrese Email"],["matInput","","formControlName","rut","placeholder","Ingrese RUT"],["matInput","","type","password","formControlName","password","placeholder","Ingrese Contrase\xf1a"],["matInput","","type","password","formControlName","repetirContrasena","placeholder","Repetir Contrase\xf1a"],[1,"mat-subtitle-2","f-w-600","d-block","m-b-16","text-center"],[1,"client-grid"],[1,"client-item-container"],[1,"col-sm-12","text-right","m-t-16"],["mat-button","","type","button",3,"click"],["mat-raised-button","","color","primary",3,"disabled"],[1,"client-item",3,"click"],["alt","Foto del Cliente",3,"src"],[1,"client-name"]],template:function(i,r){1&i&&(e.j41(0,"mat-card",0)(1,"mat-card-content",1)(2,"form",2),e.bIt("ngSubmit",function(){return r.onSubmit()}),e.j41(3,"div",3)(4,"div",4)(5,"mat-label",5),e.EFF(6,"Perfil"),e.k0s()(),e.j41(7,"div",6)(8,"mat-form-field",7)(9,"mat-select",8),e.Z7z(10,P,2,2,"mat-option",9,e.fX1),e.k0s()()()(),e.j41(12,"div",3)(13,"div",4)(14,"mat-label",5),e.EFF(15,"Nombre "),e.k0s()(),e.j41(16,"div",6)(17,"mat-form-field",7),e.nrm(18,"input",10),e.k0s()()(),e.j41(19,"div",3)(20,"div",4)(21,"mat-label",5),e.EFF(22,"Apellido"),e.k0s()(),e.j41(23,"div",6)(24,"mat-form-field",7),e.nrm(25,"input",11),e.k0s()()(),e.j41(26,"div",3)(27,"div",4)(28,"mat-label",5),e.EFF(29,"Email"),e.k0s()(),e.j41(30,"div",6)(31,"mat-form-field",7),e.nrm(32,"input",12),e.k0s()()(),e.j41(33,"div",3)(34,"div",4)(35,"mat-label",5),e.EFF(36,"RUT"),e.k0s()(),e.j41(37,"div",6)(38,"mat-form-field",7),e.nrm(39,"input",13),e.k0s()()(),e.j41(40,"div",3)(41,"div",4)(42,"mat-label",5),e.EFF(43,"Contrase\xf1a"),e.k0s()(),e.j41(44,"div",6)(45,"mat-form-field",7),e.nrm(46,"input",14),e.k0s()()(),e.j41(47,"div",3)(48,"div",4)(49,"mat-label",5),e.EFF(50,"Repetir Contrase\xf1a"),e.k0s()(),e.j41(51,"div",6)(52,"mat-form-field",7),e.nrm(53,"input",15),e.k0s()()(),e.j41(54,"mat-label",16),e.EFF(55,"Seleccionar cliente/s"),e.k0s(),e.j41(56,"div",17),e.Z7z(57,w,5,4,"div",18,S),e.k0s(),e.j41(59,"div",3)(60,"div",19)(61,"button",20),e.bIt("click",function(){return r.onCancel()}),e.EFF(62,"Cancelar"),e.k0s(),e.j41(63,"button",21),e.EFF(64," Enviar "),e.k0s()()()()()()),2&i&&(e.R7$(2),e.Y8G("formGroup",r.clienteUsuarioForm),e.R7$(8),e.Dyx(r.perfiles),e.R7$(47),e.Dyx(r.clientes),e.R7$(6),e.Y8G("disabled",!r.isFormValid()))},dependencies:[F.MD,I.PO,d.Hu,d.RN,d.m2,U.Fg,m.RG,m.rl,m.nJ,n.YN,n.qT,n.me,n.BC,n.cb,g.fS,g.fg,h.Ve,h.VO,O.wT,x.Hl,x.$z,n.X1,n.j4,n.JD],styles:[".client-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px;padding:16px;justify-items:center;align-items:start}.client-item-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;width:150px}.client-item[_ngcontent-%COMP%]{width:150px;height:150px;border-radius:8px;overflow:hidden;cursor:pointer;transition:all .3s ease;border:3px solid transparent;padding:10px;background-color:#fff;box-shadow:0 2px 4px #0000001a;display:flex;align-items:center;justify-content:center;margin:0}.client-item[_ngcontent-%COMP%]:hover{transform:translateY(-5px);box-shadow:0 5px 15px #0003}.client-item.selected[_ngcontent-%COMP%]{border-color:#1e88e5;box-shadow:0 0 15px #1e88e54d}.client-item[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:100%;max-height:100%;object-fit:contain}.client-name[_ngcontent-%COMP%]{margin-top:8px;font-size:14px;color:#000000de;font-weight:500;text-align:center}@media (max-width: 768px){.client-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;padding:12px}.client-item-container[_ngcontent-%COMP%]{width:120px}.client-item[_ngcontent-%COMP%]{width:120px;height:120px}}",".client-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;padding:20px}.client-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:15px;border-radius:8px;cursor:pointer;transition:all .3s ease;background-color:#fff;box-shadow:0 2px 4px #0000001a}.client-item[_ngcontent-%COMP%]:hover{transform:translateY(-5px);box-shadow:0 4px 8px #0003}.client-item[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:120px;height:120px;object-fit:contain;margin-bottom:10px}.client-name[_ngcontent-%COMP%]{font-size:14px;font-weight:600;text-align:center;margin-top:10px;color:#333}.selected[_ngcontent-%COMP%]{background-color:#e3f2fd;border:2px solid #1e88e5}"]})}return a})();var M=s(7291),N=s(5386),R=s(5602);const T=(a,l)=>l.id;function $(a,l){if(1&a&&(e.j41(0,"mat-option",9),e.EFF(1),e.k0s()),2&a){const t=l.$implicit;e.Y8G("value",t),e.R7$(),e.SpI(" ",t," ")}}function _(a,l){if(1&a){const t=e.RV6();e.j41(0,"div",16)(1,"div",20),e.bIt("click",function(){const r=e.eBV(t).$implicit,o=e.XpG();return e.Njj(o.toggleClientSelection(r.id))}),e.nrm(2,"img",21),e.k0s(),e.j41(3,"div",22),e.EFF(4),e.k0s()()}if(2&a){const t=l.$implicit,i=e.XpG();e.R7$(),e.AVh("selected",i.selectedClientIds.includes(t.id)),e.R7$(),e.Y8G("src",t.logo,e.B4B),e.R7$(2),e.JRh(t.nombre)}}const V=[{path:"",component:y,data:{title:"Usuarios del sistema"}},{path:"editar/:id",component:(()=>{class a{constructor(t,i,r,o,v,u,p,f){this.fb=t,this.route=i,this.router=r,this.clientesService=o,this.tecnicosService=v,this.storage=u,this.authService=p,this.usersService=f,this.clientes=[],this.perfiles=["user","reporter","admin","superadmin"],this.selectedClientIds=[],this.clienteUsuarioForm=this.fb.group({perfil:["",n.k0.required],name:["",n.k0.required],lastName:["",n.k0.required],email:["",[n.k0.required,n.k0.email]],rut:["",n.k0.required]})}ngOnInit(){this.loadClientes(),this.route.params.subscribe(t=>{this.userId=t.id,this.loadUsuario()})}loadClientes(){this.clientesService.getClientesWithGruman().subscribe(t=>{this.clientes=t})}loadUsuario(){console.log("Cargando usuario:",this.userId),this.usersService.getUserById(this.userId).subscribe({next:t=>{console.log("Usuario cargado:",t),this.clienteUsuarioForm.patchValue({perfil:t.profile,name:t.name,lastName:t.lastName,email:t.email,rut:t.rut}),this.selectedClientIds=t.clients.map(i=>i.id)},error:t=>{console.error("Error cargando usuario:",t),c().fire("Error","No se pudo cargar la informaci\xf3n del usuario","error")}})}toggleClientSelection(t){const i=this.selectedClientIds.indexOf(t);-1===i?this.selectedClientIds.push(t):this.selectedClientIds.splice(i,1)}isFormValid(){return this.clienteUsuarioForm.valid&&this.selectedClientIds.length>0}onSubmit(){if(this.isFormValid()){const t=this.clienteUsuarioForm.value,i={...t,clientId:this.selectedClientIds};this.tecnicosService.updateTecnico(this.userId,i).subscribe({next:r=>{const o=this.storage.getItem("currentUser");console.log("Usuario actual:",o),console.log("Usuario actualizado:",r),console.log("this.userId:",this.userId),console.log("currentUser.id:",o?.id),console.log("Tipos de datos:",{userId:typeof this.userId,currentUserId:typeof o?.id}),o&&Number(o.id)===Number(this.userId)?(console.log("Entrando a la actualizaci\xf3n del usuario actual"),this.clientesService.getClientesWithGruman().subscribe(v=>{const u=v.filter(f=>this.selectedClientIds.includes(f.id)),p={...o,name:t.name,lastName:t.lastName,email:t.email,rut:t.rut,profile:t.perfil,companies:u,selectedCompany:u.find(f=>o.selectedCompany?.id===f.id)||u[0]};localStorage.setItem("currentUser",JSON.stringify(p)),this.storage.setItem("currentUser",p),this.storage.updateUser(p),console.log("Usuario actualizado:",p),c().fire("\xc9xito","Usuario actualizado correctamente","success"),this.router.navigate(["/mantenedores/usuarios"])})):(c().fire("\xc9xito","Usuario actualizado correctamente","success"),this.router.navigate(["/mantenedores/usuarios"]))},error:r=>{console.error("Error actualizando usuario:",r),c().fire("Error","No se pudo actualizar el usuario","error")}})}}onCancel(){this.router.navigate(["/mantenedores/usuarios"])}static#e=this.\u0275fac=function(i){return new(i||a)(e.rXU(n.ok),e.rXU(C.nX),e.rXU(C.Ix),e.rXU(k.T),e.rXU(j.q),e.rXU(M.n),e.rXU(N.u),e.rXU(R.g))};static#t=this.\u0275cmp=e.VBU({type:a,selectors:[["app-editar-cliente-usuario"]],standalone:!0,features:[e.aNF],decls:50,vars:2,consts:[[1,"cardWithShadow"],[1,"p-24"],[3,"ngSubmit","formGroup"],[1,"row"],[1,"col-sm-4","d-flex","align-items-center"],[1,"mat-subtitle-2","f-w-600","d-block","m-b-16"],[1,"col-sm-8"],["appearance","outline",1,"w-100"],["formControlName","perfil","placeholder","Seleccionar Perfil"],[3,"value"],["matInput","","formControlName","name","placeholder","Ingrese Nombre"],["matInput","","formControlName","lastName","placeholder","Ingrese Apellido"],["matInput","","formControlName","email","placeholder","Ingrese Email"],["matInput","","formControlName","rut","placeholder","Ingrese RUT"],[1,"mat-subtitle-2","f-w-600","d-block","m-b-16","text-center"],[1,"client-grid"],[1,"client-item-container"],[1,"d-flex","justify-content-end","gap-2","mt-3"],["mat-button","","type","button",3,"click"],["mat-raised-button","","color","primary","type","submit",3,"disabled"],[1,"client-item",3,"click"],["alt","Foto del Cliente",3,"src"],[1,"client-name","text-center","mt-2"]],template:function(i,r){1&i&&(e.j41(0,"mat-card",0)(1,"mat-card-content",1)(2,"form",2),e.bIt("ngSubmit",function(){return r.onSubmit()}),e.j41(3,"div",3)(4,"div",4)(5,"mat-label",5),e.EFF(6,"Perfil"),e.k0s()(),e.j41(7,"div",6)(8,"mat-form-field",7)(9,"mat-select",8),e.Z7z(10,$,2,2,"mat-option",9,e.fX1),e.k0s()()()(),e.j41(12,"div",3)(13,"div",4)(14,"mat-label",5),e.EFF(15,"Nombre"),e.k0s()(),e.j41(16,"div",6)(17,"mat-form-field",7),e.nrm(18,"input",10),e.k0s()()(),e.j41(19,"div",3)(20,"div",4)(21,"mat-label",5),e.EFF(22,"Apellido"),e.k0s()(),e.j41(23,"div",6)(24,"mat-form-field",7),e.nrm(25,"input",11),e.k0s()()(),e.j41(26,"div",3)(27,"div",4)(28,"mat-label",5),e.EFF(29,"Email"),e.k0s()(),e.j41(30,"div",6)(31,"mat-form-field",7),e.nrm(32,"input",12),e.k0s()()(),e.j41(33,"div",3)(34,"div",4)(35,"mat-label",5),e.EFF(36,"RUT"),e.k0s()(),e.j41(37,"div",6)(38,"mat-form-field",7),e.nrm(39,"input",13),e.k0s()()(),e.j41(40,"mat-label",14),e.EFF(41,"Seleccionar cliente/s"),e.k0s(),e.j41(42,"div",15),e.Z7z(43,_,5,4,"div",16,T),e.k0s(),e.j41(45,"div",17)(46,"button",18),e.bIt("click",function(){return r.onCancel()}),e.EFF(47,"Cancelar"),e.k0s(),e.j41(48,"button",19),e.EFF(49," Guardar "),e.k0s()()()()()),2&i&&(e.R7$(2),e.Y8G("formGroup",r.clienteUsuarioForm),e.R7$(8),e.Dyx(r.perfiles),e.R7$(33),e.Dyx(r.clientes),e.R7$(5),e.Y8G("disabled",!r.isFormValid()))},dependencies:[F.MD,d.Hu,d.RN,d.m2,m.RG,m.rl,m.nJ,g.fS,g.fg,h.Ve,h.VO,O.wT,x.Hl,x.$z,n.X1,n.qT,n.me,n.BC,n.cb,n.j4,n.JD,I.PO,U.Fg],styles:[".client-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:16px;padding:16px;justify-items:center;align-items:start}.client-item-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;width:150px}.client-item[_ngcontent-%COMP%]{width:150px;height:150px;border-radius:8px;overflow:hidden;cursor:pointer;transition:all .3s ease;border:3px solid transparent;padding:10px;background-color:#fff;box-shadow:0 2px 4px #0000001a;display:flex;align-items:center;justify-content:center;margin:0}.client-item[_ngcontent-%COMP%]:hover{transform:translateY(-5px);box-shadow:0 5px 15px #0003}.client-item.selected[_ngcontent-%COMP%]{border-color:#1e88e5;box-shadow:0 0 15px #1e88e54d}.client-item[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:100%;max-height:100%;object-fit:contain}.client-name[_ngcontent-%COMP%]{margin-top:8px;font-size:14px;color:#000000de;font-weight:500;text-align:center}@media (max-width: 768px){.client-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;padding:12px}.client-item-container[_ngcontent-%COMP%]{width:120px}.client-item[_ngcontent-%COMP%]{width:120px;height:120px}}",".client-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:20px;padding:20px;justify-items:center;align-items:start}.client-item-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;width:150px}.client-item[_ngcontent-%COMP%]{width:150px;height:150px;border-radius:8px;overflow:hidden;cursor:pointer;transition:all .3s ease;border:3px solid transparent;padding:10px;background-color:#fff;box-shadow:0 2px 4px #0000001a;display:flex;align-items:center;justify-content:center}.client-item[_ngcontent-%COMP%]:hover{transform:translateY(-5px);box-shadow:0 5px 15px #0003}.client-item.selected[_ngcontent-%COMP%]{border-color:#1e88e5;box-shadow:0 0 15px #1e88e54d}.client-item[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:100%;max-height:100%;object-fit:contain}.client-name[_ngcontent-%COMP%]{margin-top:8px;font-size:14px;color:#000000de;font-weight:500}@media (max-width: 768px){.client-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px}.client-item-container[_ngcontent-%COMP%]{width:120px}.client-item[_ngcontent-%COMP%]{width:120px;height:120px}}"]})}return a})(),data:{title:"Editar Usuario del sistema"}}]}}]);