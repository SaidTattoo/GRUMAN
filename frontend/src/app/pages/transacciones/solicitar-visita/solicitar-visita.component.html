<mat-card class="cardWithShadow">
  <mat-card-content class="p-24">
    <form [formGroup]="visitaForm" (ngSubmit)="onSubmit()" class="form-layout">
      <!-- Tipo Servicio -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Tipo Servicio</mat-label>
        </div>
        <div class="col-sm-8">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Tipo de Servicio</mat-label>
            <input type="text"
                   matInput
                   formControlName="tipoServicioId"
                   [matAutocomplete]="autoTipoServicio"
                   (focus)="onTipoServicioFocus()"
                   (keyup)="filtrarTipoServicio($event)">
            <mat-autocomplete #autoTipoServicio="matAutocomplete" [displayWith]="displayTipoServicioFn">
              <mat-option *ngFor="let tipo of filteredTipoServicio | async" [value]="tipo">
                {{tipo.nombre}}
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="visitaForm.get('tipoServicioId')?.hasError('required')">
              El tipo de servicio es requerido
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Local -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Local</mat-label>
        </div>
        <div class="col-sm-8">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Local</mat-label>
            <input type="text"
                   matInput
                   formControlName="localId"
                   [matAutocomplete]="autoLocal"
                   (keyup)="filtrarLocales($event)"
                   (focus)="onLocalFocus()"
                   placeholder="Buscar local">
            <mat-error *ngIf="visitaForm.get('localId')?.hasError('required')">
              El local es requerido
            </mat-error>
            <mat-autocomplete #autoLocal="matAutocomplete" [displayWith]="displayLocalFn">
              <mat-option *ngFor="let local of filteredLocales | async" [value]="local">
                {{local.nombre_local}}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>
      </div>

      <!-- Sector del trabajo -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Sector del trabajo</mat-label>
        </div>
        <div class="col-sm-8">
          <mat-form-field appearance="outline" class="w-100">
            <mat-select formControlName="sectorTrabajoId" placeholder="Seleccionar sector">
              @for (sector of sectores; track sector.id) {
                <mat-option [value]="sector.id">
                  {{sector.nombre}}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Especialidad -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Especialidad</mat-label>
        </div>
        <div class="col-sm-8">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Especialidad</mat-label>
            <input type="text"
                   matInput
                   formControlName="especialidad"
                   [matAutocomplete]="autoEspecialidad"
                   (focus)="onEspecialidadFocus()"
                   (keyup)="filtrarEspecialidades($event)">
            <mat-autocomplete #autoEspecialidad="matAutocomplete" [displayWith]="displayEspecialidadFn">
              <mat-option *ngFor="let especialidad of filteredEspecialidades | async" [value]="especialidad">
                {{especialidad.nombre}}
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="visitaForm.get('especialidad')?.hasError('required')">
              La especialidad es requerida
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Ticket Cliente -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Ticket {{client?.nombre || 'Cliente'}}</mat-label>
        </div>
        <div class="col-sm-8">
          <mat-form-field appearance="outline" class="w-100">
            <input matInput formControlName="ticketGruman" placeholder="Ingrese número de ticket">
            <mat-hint>Corresponde al número de ticket interno de {{client?.nombre}}</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Observaciones -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Observaciones</mat-label>
        </div>
        <div class="col-sm-8">
          <mat-form-field appearance="outline" class="w-100">
            <textarea matInput formControlName="observaciones" rows="4" placeholder="Ingrese observaciones"></textarea>
          </mat-form-field>
        </div>
      </div>

      <!-- Fecha de ingreso solicitud -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Fecha de ingreso solicitud</mat-label>
        </div>
        <div class="col-sm-8">
          <mat-form-field appearance="outline" class="w-100">
            <input matInput [matDatepicker]="picker" formControlName="fechaIngreso">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-hint>Corresponde la fecha propuesta de solución</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Subir Imágenes -->
      <div class="row">
        <div class="col-sm-4 d-flex align-items-center">
          <mat-label class="mat-subtitle-2 f-w-600 d-block m-b-16">Subir Imágenes</mat-label>
        </div>
        <div class="col-sm-8">
          <input 
            type="file" 
            #fileInput 
            (change)="onFileSelected($event)" 
            style="display: none;" 
            accept="image/*"
            multiple>
          <button type="button" mat-raised-button color="primary" (click)="fileInput.click()">
            <mat-icon>add_photo_alternate</mat-icon>
            Seleccionar Imágenes
          </button>

          <!-- Preview de imágenes -->
          <div class="row mt-3">
            @for(file of selectedFiles; track file.name; let i = $index) {
              <div class="col-sm-3 mb-3">
                <mat-card class="image-preview-card">
                  <img [src]="previewUrls[i]" [alt]="file.name" class="img-fluid">
                  <div class="image-preview-overlay">
                    <button type="button" mat-icon-button color="warn" (click)="removeImage(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                  <mat-card-footer class="p-2">
                    <small class="text-muted">{{ file.name }}</small>
                  </mat-card-footer>
                </mat-card>
              </div>
            }
          </div>
        </div>
      </div>

      <!-- Mostrar las imágenes subidas -->
     <!--  <div class="image-preview-container">
        <div *ngFor="let url of urlImage; let i = index" class="image-preview">
          <img width ="100" [src]="url" alt="Preview" class="preview-image">
        <button mat-icon-button color="warn" (click)="removeImage(i)">
            <mat-icon>delete</mat-icon>
          </button> 
        </div>
      </div>
 -->
      <!-- Botones -->
      <div class="row mt-4">
        <div class="col-12 text-end">
          <button type="submit" mat-raised-button color="primary" [disabled]="!visitaForm.valid">
            Solicitar Visita
          </button>
        </div>
      </div>
    </form>
  </mat-card-content>
</mat-card>
