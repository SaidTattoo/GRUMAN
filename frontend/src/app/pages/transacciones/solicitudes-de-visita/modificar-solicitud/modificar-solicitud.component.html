<mat-card class="cardWithShadow">
    <mat-card-content class="p-24">
        <div class="container">
  @if (isPendiente) {
    <h2>Solicitud Pendiente</h2>
  } @else if (isAprobada) {
    <h2>Solicitud Aprobada</h2>
  } @else if (isRechazada) {
    <h2>Solicitud Rechazada</h2>
  } @else if (isValidada) {
    <h2>Solicitud Validada</h2>
  } @else {
    <h2>Modificar Solicitud</h2>
  }
  
  <form [formGroup]="solicitudForm">
    <!-- Información del Cliente y Local -->
    <div class="section-title">Información General</div>
    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Cliente</mat-label>
        <input matInput formControlName="client.nombre" [disabled]="solicitud?.status === 'validada' || isRechazada">
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Local</mat-label>
        <input matInput formControlName="local.nombre_local" [disabled]="solicitud?.status === 'validada' || isRechazada">
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Dirección Local</mat-label>
        <input matInput formControlName="local.direccion" [disabled]="solicitud?.status === 'validada' || isRechazada">
      </mat-form-field>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>Técnico Asignado</mat-label>
        <mat-select formControlName="tecnico_asignado_id" [disabled]="!isPendiente || isRechazada">
          <mat-option [value]="null">Sin asignar</mat-option>
          <mat-option *ngFor="let tecnico of tecnicos" [value]="tecnico.id">
            {{tecnico.name}}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Detalles de la Solicitud -->
    <div class="section-title">Detalles de la Solicitud</div>
    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Tipo de Servicio</mat-label>
        @if (isPendiente && !isRechazada) {
          <mat-select formControlName="tipoServicioId">
            <mat-option *ngFor="let tipo of tiposServicio" [value]="tipo.id">
              {{tipo.nombre}}
            </mat-option>
          </mat-select>
        } @else {
          <input matInput formControlName="tipoServicioId" [disabled]="true">
        }
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Sector de Trabajo</mat-label>
        @if (isPendiente && !isRechazada) {
          <mat-select formControlName="sectorTrabajoId">
            <mat-option *ngFor="let sector of sectoresTrabajos" [value]="sector.id">
              {{sector.nombre}}
            </mat-option>
          </mat-select>
        } @else {
          <input matInput formControlName="sectorTrabajoId" [disabled]="true">
        }
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Especialidad</mat-label>
        @if (isValidated() || isRechazada || isValidada) {
          <input matInput [value]="solicitud?.especialidad" disabled>
        } @else {
          <mat-select formControlName="especialidad">
            <mat-option *ngFor="let especialidad of especialidades" [value]="especialidad">
              {{especialidad}}
            </mat-option>
          </mat-select>
        }
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Fecha de Ingreso</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="fechaIngreso" [disabled]="solicitud?.status === 'validada' || isRechazada">
        <mat-datepicker-toggle matSuffix [for]="picker" [disabled]="solicitud?.status === 'validada' || isRechazada"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
    </div>

    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Ticket</mat-label>
        @if (isValidated() || isRechazada || isValidada) {
          <input matInput [value]="solicitud?.ticketGruman" disabled>
        } @else {
          <input matInput formControlName="ticketGruman">
        }
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Status</mat-label>
        <input matInput [value]="solicitud?.status" disabled>
      </mat-form-field>
    </div>

    <mat-form-field appearance="fill" class="full-width">
      <mat-label>Observaciones</mat-label>
      @if (isValidated() || isRechazada || isValidada) {
        <textarea matInput [value]="solicitud?.observaciones" rows="4" disabled></textarea>
      } @else {
        <textarea matInput formControlName="observaciones" rows="4"></textarea>
      }
    </mat-form-field>

    <!-- Fechas de Servicio -->
    <div class="section-title" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">Fechas de Servicio</div>
    <div class="form-row" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">
      <mat-form-field appearance="fill">
        <mat-label>Fecha/Hora Inicio Servicio</mat-label>
        <input matInput formControlName="fecha_hora_inicio_servicio" [disabled]="solicitud?.status === 'validada' || isRechazada || isValidada">
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Fecha/Hora Fin Servicio</mat-label>
        <input matInput formControlName="fecha_hora_fin_servicio" [disabled]="solicitud?.status === 'validada' || isRechazada || isValidada">
      </mat-form-field>
    </div>

    <!-- Ubicación -->
    <div class="section-title" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">Ubicación</div>
    <div class="form-row" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">
      <mat-form-field appearance="fill">
        <mat-label>Latitud</mat-label>
        @if (isValidated() || isRechazada || isValidada) {
          <input matInput [value]="solicitud?.latitud_movil" disabled>
        } @else {
          <input matInput formControlName="latitud_movil" type="number" step="0.000001">
        }
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Longitud</mat-label>
        @if (isValidated() || isRechazada || isValidada) {
          <input matInput [value]="solicitud?.longitud_movil" disabled>
        } @else {
          <input matInput formControlName="longitud_movil" type="number" step="0.000001">
        }
      </mat-form-field>
    </div>

    <!-- Agregar después de la sección de ubicación -->
    <div class="detail-section" *ngIf="(!isPendiente && !isAprobada && !isRechazada || isValidada) && solicitud?.latitud_movil && solicitud?.longitud_movil">
      <h3>Ubicación del Local</h3>
      <div class="map-container">
        <div class="map-frame">
          <div id="map"></div>
        </div>
      </div>
    </div>

    <!-- Firma del Cliente -->
    <div class="section-title" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">Firma del Cliente</div>
    <div class="signature-container" *ngIf="(!isPendiente && !isAprobada && !isRechazada || isValidada) && solicitud?.firma_cliente">
      <img [src]="solicitud.firma_cliente" alt="Firma del cliente" class="signature-image">
    </div>

    <!-- Lista de Inspección -->
    <div class="section-title mt-4" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">Repuestos utilizados en la inspección</div>
    <div class="lista-container" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">
      @for (lista of listaInspeccion; track lista.id) {
        <div class="lista-seccion">
          <div class="seccion-header">{{ lista.name }}</div>
          <ul class="lista-items">
            @for (item of lista.items; track item.id) {
              <li>
                {{ item.name }}
                <ul class="lista-subitems">
                  @for (subItem of item.subItems; track subItem.id) {
                    <li [class.deshabilitado]="subItem.disabled">
                      {{ subItem.name }}
                      <div class="subitem-actions">
                        <button mat-mini-fab color="primary" 
                                *ngIf="solicitud?.status !== 'validada' && !isRechazada && !isValidada"
                                (click)="toggleAddRepuestoForm(subItem.id)"
                                matTooltip="Agregar repuesto">
                          <mat-icon>add</mat-icon>
                        </button>
                        @if (subItem.fotos?.length) {
                          <span class="photo-count">{{ subItem.fotos.length }} foto(s)</span>
                        }
                      </div>

                      <!-- Miniaturas de fotos -->
                      <div class="photos-container">
                        @if (getItemFotos(subItem.id)?.fotos?.length) {
                          <div class="photo-grid">
                            <div class="photo-item" *ngFor="let foto of getItemFotos(subItem.id)?.fotos">
                              <img [src]="foto" 
                                   (click)="openPhotoViewer([foto])" 
                                   [alt]="'Foto de ' + subItem.name"
                                   class="inspection-photo">
                            </div>
                          </div>
                        } @else {
                          <div class="no-photos">
                            <mat-icon>no_photography</mat-icon>
                            <span>Sin fotos</span>
                          </div>
                        }
                      </div>

                      <!-- Estado después de las fotos - Siempre se muestra independientemente de los repuestos -->
                      <div class="estado-container">
                        <span class="badge" [ngClass]="{
                          'badge-success': subItem.estado === 'conforme',
                          'badge-warning': subItem.estado === 'no_aplica',
                          'badge-danger': subItem.estado === 'no_conforme'
                        }">
                          {{ getEstadoLabel(subItem.estado) }}
                        </span>
                      </div>

                      @if (showAddRepuestoForm[subItem.id]) {
                        <div class="add-repuesto-form mat-elevation-z2">
                          <mat-form-field appearance="fill">
                            <mat-label>Seleccionar Repuesto</mat-label>
                            <mat-select [(ngModel)]="selectedRepuesto" [ngModelOptions]="{standalone: true}">
                              @for (repuesto of repuestosList; track repuesto.id) {
                                <mat-option [value]="repuesto">
                                  {{ repuesto.articulo }} - {{ repuesto.marca }} - ${{ repuesto.precio.toLocaleString('es-CL') }}
                                </mat-option>
                              }
                            </mat-select>
                          </mat-form-field>

                    <mat-form-field appearance="fill">
                      <mat-label>Cantidad</mat-label>
                      <input matInput type="number" [(ngModel)]="newRepuestoCantidad" [ngModelOptions]="{standalone: true}" min="1">
                    </mat-form-field>

                          <div class="form-actions">
                            <button mat-button (click)="toggleAddRepuestoForm(subItem.id)">
                              Cancelar
                            </button>
                            <button mat-raised-button color="primary" 
                                    (click)="addRepuestoToItem(subItem.id)">
                              Agregar
                            </button>
                          </div>
                        </div>
                      }

                      <!-- Modificamos esta sección para mostrar repuestos solo si hay repuestos válidos -->
                      @if (subItem.repuestos?.length) {
                        <ul class="repuestos-list">
                          @for (repuesto of subItem.repuestos; track $index) {
                            <!-- Solo mostrar si el repuesto tiene un repuesto asociado -->
                            @if (repuesto.repuesto) {
                              <li class="repuesto-item" [class.temporal]="!repuesto.id" [class.pending-delete]="isRepuestoPendingDelete(subItem.id, repuesto)">
                                <div class="repuesto-info">
                                  @if (!repuesto.id) {
                                    <div class="temporal-badge">
                                      Pendiente de guardar
                                    </div>
                                  }
                                  @if (isRepuestoPendingDelete(subItem.id, repuesto)) {
                                    <div class="pending-delete-badge">
                                      Pendiente de eliminar
                                    </div>
                                  }
                                  <div class="repuesto-detail">
                                    <strong>Artículo:</strong> 
                                    <span>{{ repuesto.repuesto.articulo }}</span>
                                  </div>
                                 
                                  <div class="repuesto-detail">
                                    <strong>Cantidad:</strong> 
                                    <span>{{ repuesto.cantidad }}</span>
                                  </div>
                                  <div class="repuesto-detail">
                                    <strong>Precio:</strong> 
                                    <span>${{ repuesto.repuesto.precio?.toLocaleString('es-CL') }}</span>
                                  </div>
                                  <div class="repuesto-detail">
                                    <strong>Total:</strong> 
                                    <span>${{ (repuesto.cantidad * repuesto.repuesto.precio).toLocaleString('es-CL') }}</span>
                                  </div>
                                  
                                  <div class="actions-container">
                                    <button class="delete-button" 
                                            *ngIf="solicitud?.status !== 'validada' && !isRechazada && !isValidada"
                                            matTooltip="Eliminar repuesto"
                                            (click)="deleteRepuesto(subItem.id, repuesto)">
                                      <mat-icon>delete</mat-icon>
                                    </button>
                                  </div>
                                </div>
                              </li>
                            }
                          }
                        </ul>
                        
                        <!-- Solo mostrar el total si hay repuestos válidos -->
                        @if (calculateSubItemTotal(subItem.repuestos) > 0) {
                          <div class="total-section">
                            <div class="total-amount">
                              <strong>Total General:</strong>
                              <span>${{ calculateSubItemTotal(subItem.repuestos).toLocaleString('es-CL') || '0' }}</span>
                            </div>
                          </div>
                        }
                      }
                    </li>
                  }
                </ul>
              </li>
            }
          </ul>
        </div>
      }
    </div>

    <!-- Total Final -->
    <div class="final-total-section" *ngIf="!isPendiente && !isAprobada && !isRechazada || isValidada">
      <div class="final-total-amount">
        <strong>Total Final:</strong>
        <span>${{ calculateFinalTotal().toLocaleString('es-CL') || '0' }}</span>
      </div>
    </div>

    <div class="actions">
      <button mat-button [style.color]="solicitud?.status === 'validada' || isAprobada || isRechazada ? '#1976d2' : ''" (click)="onCancel()">
        {{ solicitud?.status !== 'validada' && !isAprobada && !isRechazada ? 'Cancelar' : 'Volver' }}
      </button>

      @if (isPendiente) {
        <!-- Botones para estado pendiente -->
        <button mat-raised-button color="primary" (click)="aprobarSolicitud()" style="margin-right: 10px;">
          <mat-icon>check_circle</mat-icon> Aprobar
        </button>
        <button mat-raised-button color="warn" (click)="rechazarSolicitud()">
          <mat-icon>cancel</mat-icon> Rechazar
        </button>
      } @else if (isAprobada) {
        <!-- Banner informativo para solicitudes aprobadas -->
        <div class="approved-message" style="color: #2196F3; padding: 10px; background-color: #E3F2FD; border-radius: 4px; display: flex; align-items: center; justify-content: center; width: 100%;">
          <mat-icon style="vertical-align: middle; margin-right: 8px;">schedule</mat-icon>
          Esta solicitud está aprobada y a la espera de la visita del técnico
        </div>
      } @else if (isRechazada) {
        <!-- Banner informativo para solicitudes rechazadas -->
        <div class="rejected-message" style="color: #F44336; padding: 15px; background-color: #FFEBEE; border-radius: 4px; display: flex; align-items: center; justify-content: center; width: 100%; flex-direction: column; margin-bottom: 15px;">
          <div style="display: flex; align-items: center; width: 100%; justify-content: center; margin-bottom: 10px;">
            <mat-icon style="vertical-align: middle; margin-right: 8px; font-size: 28px; height: 28px; width: 28px;">cancel</mat-icon>
            <span style="font-weight: bold; font-size: 18px;">Esta solicitud fue rechazada</span>
          </div>
          
          <!-- Información de quién rechazó -->
          @if (solicitud?.rechazada_por_id && usuarioRechazo) {
            <div style="width: 100%; text-align: center; margin-top: 8px; font-size: 16px;">
              <strong>Rechazada por:</strong> {{ usuarioRechazo.name }} {{ usuarioRechazo.lastName }}
            </div>
          }
          
          <!-- Fecha de rechazo (Solo se mostrará si hay) -->
          @if (solicitud?.fecha_rechazo) {
            <div style="width: 100%; text-align: center; margin-top: 8px; font-size: 16px;">
              <strong>Fecha:</strong> {{ solicitud.fecha_rechazo | date:'dd/MM/yyyy HH:mm' }}
            </div>
          }
          
          <!-- Observación de rechazo -->
          @if (solicitud?.observacion_rechazo) {
            <div style="width: 100%; text-align: center; margin-top: 8px; padding: 10px; background-color: rgba(244, 67, 54, 0.1); border-radius: 4px; font-size: 16px;">
              <strong>Motivo:</strong> {{ solicitud.observacion_rechazo }}
            </div>
          }
        </div>
      } @else if (solicitud?.status !== 'validada' && !isValidada) {
        <!-- Botones para estados diferentes a pendiente, aprobada y validada -->
        <button mat-raised-button color="primary" (click)="onSaveRepuestos()" style="margin-right: 10px;">
          <mat-icon>save</mat-icon>
          Guardar Repuestos
        </button>
        <button mat-raised-button style="background-color: #4CAF50; color: white;" (click)="onValidate()">
          Validar Solicitud
        </button>
      } @else {
        <div class="validation-message" style="color: #4CAF50; padding: 10px; background-color: #E8F5E9; border-radius: 4px; display: flex; align-items: center; justify-content: center; width: 100%;">
          <mat-icon style="vertical-align: middle; margin-right: 8px;">check_circle</mat-icon>
          Esta solicitud fue validada el {{ solicitud.fecha_hora_validacion | date:'dd/MM/yyyy HH:mm' }}
        </div>
      }
    </div>

   

  </form>
</div>

</mat-card-content>
</mat-card>

<style>
.rejection-info-card {
  margin: 15px 0 25px;
  padding: 15px;
  background-color: #FFEBEE;
  border-radius: 8px;
  border: 1px solid rgba(244, 67, 54, 0.3);
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.rejection-info-card h3 {
  margin: 0;
  font-size: 16px;
  color: #D32F2F;
  font-weight: 500;
}

.rejection-info-card p {
  margin: 5px 0 0;
  font-size: 15px;
  color: #424242;
}

.rejection-reason {
  padding: 10px;
  background-color: rgba(244, 67, 54, 0.08);
  border-radius: 4px;
}

.rejection-by, .rejection-date {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 10px;
}

.signature-container {
  margin: 20px 0;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.signature-image {
  max-width: 100%;
  height: auto;
}

.table-container {
  margin: 20px 0;
  overflow-x: auto;
}

table {
  width: 100%;
}

th.mat-header-cell,
td.mat-cell {
  padding: 12px;
}

.mat-row:nth-child(even) {
  background-color: #f5f5f5;
}

.mat-header-row {
  background-color: #f0f0f0;
}

.lista-container {
  padding: 1rem;
}

.lista-seccion {
  margin-bottom: 2rem;
}

.seccion-header {
  background-color: #f0f2f5;
  padding: 12px 16px;
  border-radius: 6px;
  font-weight: 500;
  color: #1a1f36;
  font-size: 16px;
  margin-bottom: 1rem;
}

.lista-items {
  margin: 0;
  padding-left: 2rem;
  list-style: none;
}

.lista-items li {
  position: relative;
  padding: 8px 0;
  color: #1a1f36;
  font-weight: 500;
}

.lista-items li::before {
  content: "•";
  position: absolute;
  left: -1rem;
  color: #3498db;
}

.lista-subitems {
  margin: 0.5rem 0 0.5rem 1rem;
  padding-left: 1rem;
  list-style: none;
}

.lista-subitems li {
  padding: 4px 0;
  color: #4a5568;
  font-weight: normal;
}

.lista-subitems li.deshabilitado {
  color: #a0aec0;
  text-decoration: line-through;
}

.repuestos-list {
  margin: 0.5rem 0;
  padding-left: 1.5rem;
  list-style: none;
  font-size: 0.9em;
}

.repuesto-item {
  position: relative;
  padding: 12px 16px;
  margin: 8px 0;
  background-color: #f8f9fa;
  border-radius: 6px;
  border-left: 3px solid #3498db;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.repuesto-item.temporal {
  border-left: 3px solid #f39c12;
  background-color: #fff9e6;
}

.repuesto-item.pending-delete {
  border-left: 3px solid #e74c3c;
  background-color: #fee2e2;
}

.repuesto-info {
  display: grid;
  grid-template-columns: repeat(5, 1fr) auto;
  gap: 12px;
  align-items: center;
  width: 100%;
}

.repuesto-detail {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px;
}

.repuesto-detail strong {
  color: #2c3e50;
  min-width: 65px;
  font-size: 0.9em;
}

.repuesto-detail span {
  color: #34495e;
  font-size: 0.9em;
}

.repuesto-item::before {
  display: none;
}

.delete-button {
  color: #e74c3c;
  cursor: pointer;
  padding: 4px;
  border: none;
  background: none;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: background-color 0.2s;
}

.delete-button:hover {
  background-color: #fee2e2;
}

.subitem-actions {
  display: inline-flex;
  align-items: center;
  margin-left: 12px;
}

.subitem-actions .mat-mini-fab {
  transform: scale(0.8);
}

.add-repuesto-form {
  margin: 12px 0;
  padding: 16px;
  background-color: white;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

.mat-mini-fab {
  box-shadow: none;
}

.temporal-badge {
  position: absolute;
  top: -8px;
  right: 8px;
  background-color: #f39c12;
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
}

.pending-delete-badge {
  position: absolute;
  top: -8px;
  right: 8px;
  background-color: #e74c3c;
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
}

.total-section {
  margin-top: 12px;
  padding: 12px;
  background-color: #f8f9fa;
  border-radius: 6px;
  border-left: 3px solid #2ecc71;
}

.total-amount {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 12px;
  font-size: 1.1em;
}

.total-amount strong {
  color: #2c3e50;
}

.total-amount span {
  color: #2ecc71;
  font-weight: 500;
}

.final-total-section {
  margin-top: 24px;
  padding: 16px;
  background-color: #2c3e50;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.final-total-amount {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 16px;
  font-size: 1.3em;
}

.final-total-amount strong {
  color: white;
}

.final-total-amount span {
  color: #2ecc71;
  font-weight: 600;
  font-size: 1.2em;
}

.photos-container {
  margin: 10px 0;
}

.photo-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.photo-item {
  aspect-ratio: 1;
  overflow: hidden;
  border-radius: 4px;
  border: 1px solid #ddd;
}

.inspection-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.2s;
}

.inspection-photo:hover {
  transform: scale(1.05);
}

.no-photos {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background-color: #f5f5f5;
  border-radius: 4px;
  border: 1px dashed #ccc;
  color: #666;
  gap: 8px;
}

.no-photos mat-icon {
  font-size: 24px;
  width: 24px;
  height: 24px;
}

.no-photos span {
  font-size: 14px;
}
</style>

 